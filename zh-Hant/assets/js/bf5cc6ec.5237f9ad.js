"use strict";(self.webpackChunk_lexical_website=self.webpackChunk_lexical_website||[]).push([[9448],{47218:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var t=r(31085),i=r(71184);const o={sidebar_position:2},s="\u5408\u4f5c\u5e38\u898b\u554f\u984c\u89e3\u7b54",a={id:"collaboration/faq",title:"\u5408\u4f5c\u5e38\u898b\u554f\u984c\u89e3\u7b54",description:"\u771f\u5be6\u4f86\u6e90\uff1aLexical State\u3001Yjs \u548c\u61c9\u7528\u7a0b\u5f0f\u7684\u8cc7\u6599\u5eab",source:"@site/i18n/zh-Hant/docusaurus-plugin-content-docs/current/collaboration/faq.md",sourceDirName:"collaboration",slug:"/collaboration/faq",permalink:"/zh-Hant/docs/collaboration/faq",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/lexical/tree/main/packages/lexical-website/docs/collaboration/faq.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"docs",previous:{title:"React",permalink:"/zh-Hant/docs/collaboration/react"},next:{title:"\u5e38\u898b\u554f\u984c",permalink:"/zh-Hant/docs/faq"}},d={},c=[{value:"\u771f\u5be6\u4f86\u6e90\uff1aLexical State\u3001Yjs \u548c\u61c9\u7528\u7a0b\u5f0f\u7684\u8cc7\u6599\u5eab",id:"\u771f\u5be6\u4f86\u6e90lexical-stateyjs-\u548c\u61c9\u7528\u7a0b\u5f0f\u7684\u8cc7\u6599\u5eab",level:2},{value:"\u5f9e Yjs \u6587\u6a94\u521d\u59cb\u5316 <code>EditorState</code>",id:"\u5f9e-yjs-\u6587\u6a94\u521d\u59cb\u5316-editorstate",level:2}];function l(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"\u5408\u4f5c\u5e38\u898b\u554f\u984c\u89e3\u7b54",children:"\u5408\u4f5c\u5e38\u898b\u554f\u984c\u89e3\u7b54"})}),"\n",(0,t.jsx)(n.h2,{id:"\u771f\u5be6\u4f86\u6e90lexical-stateyjs-\u548c\u61c9\u7528\u7a0b\u5f0f\u7684\u8cc7\u6599\u5eab",children:"\u771f\u5be6\u4f86\u6e90\uff1aLexical State\u3001Yjs \u548c\u61c9\u7528\u7a0b\u5f0f\u7684\u8cc7\u6599\u5eab"}),"\n",(0,t.jsx)(n.p,{children:"\u5efa\u8b70\u5c07 Yjs \u6a21\u578b\u8996\u70ba\u771f\u5be6\u4f86\u6e90\u3002\u60a8\u53ef\u4ee5\u5c07\u6587\u6a94\u5b58\u5132\u5230\u8cc7\u6599\u5eab\u4e2d\u4ee5\u9032\u884c\u7d22\u5f15\u3002\u4f46\u5982\u679c\u53ef\u80fd\uff0c\u60a8\u61c9\u8a72\u6c38\u9060\u8a18\u4f4f Yjs \u6a21\u578b\uff0c\u56e0\u70ba\u9019\u662f\u552f\u4e00\u53ef\u4ee5\u8b93\u6c92\u6709\u7db2\u8def\u9023\u63a5\u7684\u5ba2\u6236\u7aef\u53ef\u9760\u5730\u52a0\u5165\u4e26\u8207\u4f3a\u670d\u5668\u540c\u6b65\u7684\u65b9\u6cd5\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u60a8\u4e5f\u53ef\u4ee5\u5c07\u8cc7\u6599\u5eab\u8996\u70ba\u771f\u5be6\u4f86\u6e90\u3002\u9019\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u5be6\u73fe\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u5ba2\u6236\u7aef\u5728\u9023\u63a5\u5230\u4f3a\u670d\u5668\u6642\u6703\u6536\u5230\u4e00\u500b ",(0,t.jsx)(n.code,{children:"sessionId"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u7576\u5ba2\u6236\u7aef\u5728\u6c92\u6709\u73fe\u6709 ",(0,t.jsx)(n.code,{children:"sessionId"})," \u7684\u60c5\u6cc1\u4e0b\u9023\u63a5\u6642\uff0c\u5f9e\u8cc7\u6599\u5eab\u4e2d\u7372\u53d6\u5167\u5bb9\u4e26\u5275\u5efa\u4e00\u500b ",(0,t.jsx)(n.code,{children:"sessionId"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u7576\u6240\u6709\u5ba2\u6236\u7aef\u65b7\u958b\u9023\u63a5\u6642\uff0c\u4f3a\u670d\u5668\u5728\u67d0\u500b\u8d85\u6642\u5f8c\uff08\u4f8b\u5982 1 \u5c0f\u6642\uff09\u5fd8\u8a18\u623f\u9593\u5167\u5bb9\u548c ",(0,t.jsx)(n.code,{children:"sessionId"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u7576\u5ba2\u6236\u7aef\u91cd\u65b0\u9023\u63a5\u6642\uff0c\u4f7f\u7528\u4f3a\u670d\u5668\u4e0a\u7684\u5167\u5bb9\u3002\u6b64\u5916\uff0c\u5f9e\u5ba2\u6236\u7aef\u7372\u53d6 ",(0,t.jsx)(n.code,{children:"sessionId"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u7576\u5169\u500b\u64c1\u6709\u4e0d\u540c ",(0,t.jsx)(n.code,{children:"sessionId"})," \u7684\u5ba2\u6236\u7aef\u91cd\u65b0\u9023\u63a5\u6642\uff0c\u61c9\u8a72\u6709\u4e00\u500b\u5ba2\u6236\u7aef\u5fd8\u8a18\u623f\u9593\u5167\u5bb9\u3002",(0,t.jsx)(n.em,{children:"\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5ba2\u6236\u7aef\u6703\u4e1f\u5931\u5167\u5bb9"})," - \u96d6\u7136\u5982\u679c\u60a8\u5c07\u5fd8\u8a18\u8d85\u6642\uff08\u898b\u7b2c 2 \u9ede\uff09\u8a2d\u7f6e\u5f97\u975e\u5e38\u9ad8\uff0c\u9019\u7a2e\u60c5\u6cc1\u662f\u4e0d\u592a\u53ef\u80fd\u767c\u751f\u7684\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u6216\u8005\uff0c\u6709\u4e00\u7a2e\u66f4\u7c21\u55ae\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u7576\u5ba2\u6236\u7aef\u9023\u63a5\u5230\u4f3a\u670d\u5668\u6642\uff0c\u4f3a\u670d\u5668\u5982\u679c\u623f\u9593\u5167\u5bb9\u70ba\u7a7a\uff0c\u5247\u586b\u5145\u623f\u9593\u5167\u5bb9"}),"\n",(0,t.jsx)(n.li,{children:"\u7576\u6240\u6709\u5ba2\u6236\u7aef\u65b7\u958b\u9023\u63a5\u6642\uff0c\u4f3a\u670d\u5668\u5728\u67d0\u500b\u8d85\u6642\u5f8c\uff08\u4f8b\u5982 1 \u5c0f\u6642\uff09\u5fd8\u8a18\u623f\u9593\u5167\u5bb9"}),"\n",(0,t.jsx)(n.li,{children:"\u7576\u5ba2\u6236\u7aef\u7121\u6cd5\u5728 40 \u5206\u9418\u5167\u91cd\u65b0\u9023\u63a5\u6642\uff0c\u5ba2\u6236\u7aef\u5fc5\u9808\u5fd8\u8a18\u5176\u672c\u5730\u66f4\u65b0\u4e26\u91cd\u65b0\u958b\u59cb\uff08\u9019\u61c9\u7531\u4f3a\u670d\u5668\u5f37\u5236\u57f7\u884c\uff09"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u7576\u8cc7\u6599\u5eab\u662f\u552f\u4e00\u771f\u5be6\u4f86\u6e90\u6642\uff0c\u5982\u679c\u60a8\u5e0c\u671b\u80fd\u5920\u5fd8\u8a18 Yjs \u6a21\u578b\uff0c\u60a8\u5c07\u7e3d\u662f\u9047\u5230\u5ba2\u6236\u7aef\u7121\u6cd5\u63d0\u4ea4\u66f4\u6539\u7684\u60c5\u6cc1\u3002\u9019\u5728\u5927\u591a\u6578\u9805\u76ee\u4e2d\u4e0d\u6703\u592a\u7cdf\u7cd5\u3002\u9019\u6703\u5728\u67d0\u7a2e\u7a0b\u5ea6\u4e0a\u9650\u5236\u60a8\uff0c\u56e0\u70ba\u60a8\u4e0d\u80fd\u4f7f\u7528 y-indexeddb \u5728\u5ba2\u6236\u7aef\u7de9\u5b58\u6587\u6a94\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u9019\u6a23\u7dad\u8b77\u8d77\u4f86\u66f4\u5bb9\u6613\uff0c\u4e5f\u66f4\u5bb9\u6613\u9032\u884c Yjs \u5347\u7d1a\u3002\u6b64\u5916\uff0c\u5927\u591a\u6578\u4eba\u6703\u8aaa SQL \u6bd4 Yjs \u66f4\u53ef\u9760\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.em,{children:["* \u57fa\u65bc Yjs \u4f5c\u8005 ",(0,t.jsx)(n.a,{href:"https://github.com/yjs/yjs/issues/82#issuecomment-328365015",children:"Kevin Jahns"})," \u7684\u5efa\u8b70"]})}),"\n",(0,t.jsxs)(n.h2,{id:"\u5f9e-yjs-\u6587\u6a94\u521d\u59cb\u5316-editorstate",children:["\u5f9e Yjs \u6587\u6a94\u521d\u59cb\u5316 ",(0,t.jsx)(n.code,{children:"EditorState"})]}),"\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u901a\u904e\u5229\u7528\u7121\u982d Lexical \u548c Yjs \u7684 no-op \u63d0\u4f9b\u8005\u4f86\u5be6\u73fe\uff1a"}),"\n",(0,t.jsxs)(r,{children:[(0,t.jsx)("summary",{children:"createHeadlessCollaborativeEditor.ts"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import type {Binding, Provider} from '@lexical/yjs';\r\nimport type {\r\n  Klass,\r\n  LexicalEditor,\r\n  LexicalNode,\r\n  LexicalNodeReplacement,\r\n  SerializedEditorState,\r\n  SerializedLexicalNode,\r\n} from 'lexical';\r\n\r\nimport {createHeadlessEditor} from '@lexical/headless';\r\nimport {\r\n  createBinding,\r\n  syncLexicalUpdateToYjs,\r\n  syncYjsChangesToLexical,\r\n} from '@lexical/yjs';\r\nimport {type YEvent, applyUpdate, Doc, Transaction} from 'yjs';\r\n\r\nexport default function headlessConvertYDocStateToLexicalJSON(\r\n  nodes: ReadonlyArray<Klass<LexicalNode> | LexicalNodeReplacement>,\r\n  yDocState: Uint8Array,\r\n): SerializedEditorState<SerializedLexicalNode> {\r\n  return withHeadlessCollaborationEditor(nodes, (editor, binding) => {\r\n    applyUpdate(binding.doc, yDocState, {isUpdateRemote: true});\r\n    editor.update(() => {}, {discrete: true});\r\n\r\n    return editor.getEditorState().toJSON();\r\n  });\r\n}\r\n\r\n/**\r\n * \u5275\u5efa\u7121\u982d\u5354\u4f5c\u7de8\u8f2f\u5668\uff0c\u4e26\u4f7f\u7528 no-op \u63d0\u4f9b\u8005\uff08\u56e0\u70ba\u5b83\u4e0d\u6703\u9023\u63a5\u5230\u6d88\u606f\u5206\u767c\u57fa\u790e\u8a2d\u65bd\uff09\u548c\u7d81\u5b9a\u3002\u5b83\u9084\u8a2d\u7f6e\u4e86 yDoc \u548c\u7de8\u8f2f\u5668\u4e4b\u9593\u7684\u96d9\u5411\u540c\u6b65\u3002\r\n */\r\nfunction withHeadlessCollaborationEditor<T>(\r\n  nodes: ReadonlyArray<Klass<LexicalNode> | LexicalNodeReplacement>,\r\n  callback: (editor: LexicalEditor, binding: Binding, provider: Provider) => T,\r\n): T {\r\n  const editor = createHeadlessEditor({\r\n    nodes,\r\n  });\r\n\r\n  const id = 'main';\r\n  const doc = new Doc();\r\n  const docMap = new Map([[id, doc]]);\r\n  const provider = createNoOpProvider();\r\n  const binding = createBinding(editor, provider, id, doc, docMap);\r\n\r\n  const unsubscribe = registerCollaborationListeners(editor, provider, binding);\r\n\r\n  const res = callback(editor, binding, provider);\r\n\r\n  unsubscribe();\r\n\r\n  return res;\r\n}\r\n\r\nfunction registerCollaborationListeners(\r\n  editor: LexicalEditor,\r\n  provider: Provider,\r\n  binding: Binding,\r\n): () => void {\r\n  const unsubscribeUpdateListener = editor.registerUpdateListener(\r\n    ({\r\n      dirtyElements,\r\n      dirtyLeaves,\r\n      editorState,\r\n      normalizedNodes,\r\n      prevEditorState,\r\n      tags,\r\n    }) => {\r\n      if (tags.has('skip-collab') === false) {\r\n        syncLexicalUpdateToYjs(\r\n          binding,\r\n          provider,\r\n          prevEditorState,\r\n          editorState,\r\n          dirtyElements,\r\n          dirtyLeaves,\r\n          normalizedNodes,\r\n          tags,\r\n        );\r\n      }\r\n    },\r\n  );\r\n\r\n  const observer = (events: Array<YEvent<any>>, transaction: Transaction) => {\r\n    if (transaction.origin !== binding) {\r\n      syncYjsChangesToLexical(binding, provider, events, false);\r\n    }\r\n  };\r\n\r\n  binding.root.getSharedType().observeDeep(observer);\r\n\r\n  return () => {\r\n    unsubscribeUpdateListener();\r\n    binding.root.getSharedType().unobserveDeep(observer);\r\n  };\r\n}\r\n\r\nfunction createNoOpProvider(): Provider {\r\n  const emptyFunction = () => {};\r\n\r\n  return {\r\n    awareness: {\r\n      getLocalState: () => null,\r\n      getStates: () => new Map(),\r\n      off: emptyFunction,\r\n      on: emptyFunction,\r\n      setLocalState: emptyFunction,\r\n    },\r\n    connect: emptyFunction,\r\n    disconnect: emptyFunction,\r\n    off: emptyFunction,\r\n    on: emptyFunction,\r\n  };\r\n}\n"})})]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>a});var t=r(14041);const i={},o=t.createContext(i);function s(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);